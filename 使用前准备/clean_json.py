#åˆå¹¶ä¸‹è½½çš„jsonæ–‡ä»¶ ç”¨äºchat-analyticsè¿›è¡Œåˆ†æ
import os
import json
import glob
import re
import csv
import time

# ================= é…ç½®åŒºåŸŸ =================
CSV_FILE_PATH = "all_threads.csv"
JSON_FILES_PATTERN = r"E:\discord-backups1.5\discord-backups\backup\**\*.json"
OUTPUT_FILENAME = "merged_final_clean.json"
TARGET_CATEGORY_ID = "1019924310665728022"


# ===========================================

def get_id_from_filename(filename):
    match = re.search(r'\[(\d+)\]\.json$', filename)
    if match:
        return match.group(1)
    return None


def merge_fix_header():
    # --- 1. è¯»å– CSV ---
    print(f"ğŸš€ [ç¬¬ä¸€æ­¥] è¯»å– CSV ç´¢å¼•...")
    valid_ids = set()
    try:
        with open(CSV_FILE_PATH, 'r', encoding='utf-8-sig') as f:
            reader = csv.DictReader(f)
            # è‡ªåŠ¨æ‰¾ ID åˆ—
            headers = reader.fieldnames
            if not headers: return
            id_col = next((col for col in headers if col.strip().lower() == 'id'), None)
            if id_col:
                for row in reader:
                    if row.get(id_col):
                        valid_ids.add(str(row[id_col]).strip())
    except Exception as e:
        print(f"âŒ CSV è¯»å–é”™è¯¯: {e}")
        return
    print(f"ğŸ“‹ CSV æœ‰æ•ˆ ID æ•°: {len(valid_ids)}")

    # --- 2. æ‰«ææ–‡ä»¶ ---
    print(f"\nğŸš€ [ç¬¬äºŒæ­¥] æ‰«ææ–‡ä»¶...")
    all_files = glob.glob(JSON_FILES_PATTERN, recursive=True)
    print(f"ğŸ“Š æ‰¾åˆ° {len(all_files)} ä¸ªæ–‡ä»¶ã€‚")

    # --- 3. è¯»å–å¹¶å»é‡ ---
    print(f"\nğŸš€ [ç¬¬ä¸‰æ­¥] è¯»å–å¹¶æ¸…æ´—...")
    unique_messages = {}

    # ä¸´æ—¶å­˜å‚¨ä¸€ä¸ªçœŸå®çš„ Guild ä¿¡æ¯ç”¨äºä¼ªé€ ï¼Œå¦‚æœæ²¡æ‰¾åˆ°å°±ç”¨é»˜è®¤çš„
    real_guild_info = {
        "id": "000000000000000000",
        "name": "Merged Server Backup",
        "iconUrl": None
    }

    processed_files = 0

    for index, filepath in enumerate(all_files):
        if filepath.endswith(OUTPUT_FILENAME): continue

        fname = os.path.basename(filepath)
        fid = get_id_from_filename(fname)
        if fid and fid not in valid_ids: continue

        try:
            with open(filepath, 'r', encoding='utf-8') as f:
                data = json.load(f)

                # å°è¯•æŠ“å–ä¸€æ¬¡çœŸå®çš„å…¬ä¼šä¿¡æ¯
                if processed_files == 0 and 'guild' in data:
                    real_guild_info = data['guild']

                msgs = data.get('messages', [])
                if msgs:
                    for msg in msgs:
                        if msg.get('id') and msg.get('timestamp'):
                            unique_messages[msg['id']] = msg

                processed_files += 1

        except:
            pass

        if (index + 1) % 5000 == 0:
            print(f"â³ è¿›åº¦: {index + 1}/{len(all_files)} | æ¶ˆæ¯æ± : {len(unique_messages)}")

    if not unique_messages:
        print("âŒ é”™è¯¯ï¼šæ²¡æœ‰æå–åˆ°ä»»ä½•æ¶ˆæ¯ï¼")
        return

    # --- 4. æ’åº ---
    print(f"\nğŸš€ [ç¬¬å››æ­¥] æ­£åœ¨æ’åº {len(unique_messages)} æ¡æ¶ˆæ¯...")
    final_messages_list = list(unique_messages.values())
    final_messages_list.sort(key=lambda x: int(x['id']))

    # --- 5. æ„é€ â€œå®Œç¾å¤´éƒ¨â€å¹¶å†™å…¥ (æ ¸å¿ƒä¿®æ”¹) ---
    print(f"\nğŸš€ [ç¬¬äº”æ­¥] æ„é€ å®Œç¾å¤´éƒ¨å¹¶å†™å…¥...")

    # æ‰‹åŠ¨æ„é€ ä¸€ä¸ª chat-analytics ç»å¯¹å–œæ¬¢çš„æ ‡å‡†å¤´éƒ¨
    # å¼ºåˆ¶å°† type è®¾ä¸º GuildText (0)ï¼Œä¼ªè£…æˆæ™®é€šé¢‘é“
    final_output = {
        "guild": real_guild_info,
        "channel": {
            "id": TARGET_CATEGORY_ID,
            "type": "GuildText",
            "categoryId": TARGET_CATEGORY_ID,
            "category": "æ—¥å¸¸å†²æµªåŒº",
            "name": "2025-All-Threads-Merged",
            "topic": "Generated by Merge Script"
        },
        "dateRange": {
            "after": None,
            "before": None
        },
        "exportedAt": "2026-01-16T00:00:00.0000000+00:00",
        "messages": final_messages_list,
        "messageCount": len(final_messages_list)
    }

    with open(OUTPUT_FILENAME, 'w', encoding='utf-8') as f:
        json.dump(final_output, f, ensure_ascii=False, indent=2)

    print("=" * 40)
    print(f"ğŸ‰ ä¿®å¤å®Œæˆï¼")
    print(f"ğŸ“‚ ç”Ÿæˆæ–‡ä»¶: {os.path.abspath(OUTPUT_FILENAME)}")
    print(f"ğŸ’¬ åŒ…å«æ¶ˆæ¯: {len(final_messages_list)}")
    print(f"â„¹ï¸ å·²å¼ºåˆ¶å°†é¢‘é“ç±»å‹ä¼ªè£…ä¸º 'GuildText'")
    print("=" * 40)


if __name__ == "__main__":
    merge_fix_header()